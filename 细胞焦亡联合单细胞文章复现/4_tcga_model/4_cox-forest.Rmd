---
title: "cox-forest"
author: "ç”Ÿä¿¡æŠ€èƒ½æ ‘"
output: rmarkdown::html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_chunk$set(fig.width = 7,fig.height = 5, collapse = TRUE,message = F,warning = F)
```

### 1.å‡†å¤‡è¾“å…¥æ•°æ®

```{r}
rm(list = ls())
proj = "TCGA-STAD"
load(paste0(proj,"_sur_model.Rdata"))
load(paste0(proj,"_lassogene.Rdata"))
g = lassoGene
exprSet = exprSet[g,]
```

### 2.æ„å»ºcoxphæ¨¡å‹ 

å°†ç”¨äºå»ºæ¨¡çš„åŸºå› ï¼ˆä¾‹å¦‚lassoå›å½’é€‰ä¸­çš„åŸºå› ï¼‰ä»è¡¨è¾¾çŸ©é˜µä¸­å–å‡ºæ¥ï¼Œï¼Œå¯ä½œä¸ºåˆ—æ·»åŠ åœ¨metaè¡¨å™¶çš„åé¢,ç»„æˆçš„æ•°æ®æ¡†èµ‹å€¼ç»™datã€‚

```{r}
library(stringr)
e=t(exprSet)
colnames(e)= str_replace_all(colnames(e),"-","_")
dat=cbind(meta,e) 

dat$gender=as.numeric(factor(dat$gender))
dat$stage=as.numeric(factor(dat$stage))
colnames(dat)
```

```{r}
library(survival)
library(survminer)
model = coxph(formula = Surv(time, event) ~ ., data = dat[, -c(1, 4:10)])
#æ³¢æµªå·åé¢çš„ç‚¹â€œ.â€ä»£è¡¨é™¤äº†timeå’Œeventå¤–çš„å…¶ä»–æ‰€æœ‰åˆ—
#è¿™ä¸€æ­¥ä»…ä½¿ç”¨åŸºå› ï¼Œä¸éœ€è¦ä¸´åºŠä¿¡æ¯ï¼Œæ‰€ä»¥å»æ‰äº†IDå’Œä¸´åºŠä¿¡æ¯åˆ—
```

é€æ­¥å›å½’æ³•å¯ä»¥å¸®ä½ æ‹¿åˆ°æœ€ä¼˜æ¨¡å‹

```{r,results='hide'}
model2 = step(coxph(formula = Surv(time, event) ~ ., data = dat[, -c(1, 4:10)]))
#å¦‚æœå†³å®šä½¿ç”¨æ­¤ç»“æœå°±åˆ æ‰#ğŸ‘‡
#model = model2
```


#### é£é™©æ£®æ—å›¾

```{r}
ggforest(model,data = dat)
```

### 4.æ¨¡å‹é¢„æµ‹å’Œè¯„ä¼°

```{r }
#è®¡ç®—é¢„æµ‹å€¼ï¼ŒåŸºå› è¡¨è¾¾é‡çš„åŠ æƒæ±‚å’Œï¼Œapplyå®ç°äº†æ‰¹é‡è®¡ç®—ï¼Œæ‰€æœ‰æ ·æœ¬éƒ½è®¡ç®—ã€‚
fp = apply(dat[,names(model$coefficients)], 1, function(x){
  sum(x * model$coefficients)
})
head(fp)
library(Hmisc)
options(scipen=200)
rcorr.cens(-fp,Surv(dat$time, dat$event))
#å°†é£é™©å€¼å’Œé£é™©åˆ†ç»„ä½œä¸ºä¸€åˆ—åŠ åˆ°daté‡Œé¢
dat$Riskscore = fp
dat$Risk = ifelse(fp<median(fp),"low_risk","high_risk")
dat$Risk = factor(dat$Risk,levels = c("low_risk","high_risk"))
save(dat,model,fp,file = paste0(proj,"cox_fp.Rdata"))
```

#### åˆ’åˆ†é«˜ä½é£é™©å¹¶ç”»KM-plot

```{r}
sfit <- survfit(Surv(time, event)~Risk, data=dat)

ggsurvplot(sfit,palette = "jco",
           risk.table =TRUE,pval =TRUE,xlab ="Time in months", 
           ggtheme =theme_classic())
```

#### é£é™©å› å­ä¸‰å›¾è”åŠ¨

```{r}
library(tinyarray)
#tinyarrayé‡Œç°æˆçš„å‡½æ•°
risk_plot(exprSet_hub = t(dat[,names(model$coefficients)]),
          meta = meta,
          riskscore = fp)
packageVersion("tinyarray")
#åœ¨2.4.1ä»¥ä¸Šçš„æ–°ç‰ˆæœ¬é‡Œæ·»åŠ äº†ä¸€ä¸ªå‚æ•°n_cutoff,é»˜è®¤å€¼æ˜¯3ï¼Œæ„æ€æ˜¯æŠŠçƒ­å›¾é¢œè‰²èŒƒå›´è®¾ç½®ä¸º-3~3ä¹‹é—´ï¼Œé¢œè‰²ä¼šæ›´é²œæ˜ï¼Œä»£ç ä¸å˜ï¼Œæ›´æ–°ä¸€ä¸‹é¢œå€¼æ›´é«˜ğŸ˜„
```



